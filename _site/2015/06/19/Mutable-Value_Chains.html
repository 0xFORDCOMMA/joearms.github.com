<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Joe Armstrong" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    
    <title>Mutable Value Chains</title>
    
    <!-- Bootstrap -->
    <link href="/css/bootstrap.min.css" rel="stylesheet" media="screen" />
    <link href="/css/bootstrap-responsive.min.css" rel="stylesheet" />
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />
    <link rel="stylesheet" href="/css/screen.css" type="text/css" 
	  media="screen, projection" />
  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
	<a class="brand" href="/index.html">Joe Armstrong - Erlang and other stuff</a>
	<ul class="nav">
	  <li><a href="/index.html">Home</a></li>
	  <li><a href="/archive.html">Archive</a></li>
	  <li><a href="/resources.html">Resources</a></li>
	  <li><a href="/installing.html">Installing</a></li>
	  <li><a href="/links.html">Links</a></li>
	  <li><a href="https://github.com/joearms/joearms.github.com/">Source</a></li>
	</ul>
      </div>
    </div>
    
    <div class="customize">
      <div class="row-fluid">
	<div class="span7 offset1">
	  <div>
  <div id="title">
  
    <h1>Mutable Value Chains</h1>
    <span class="meta">19 Jun 2015</span>
    <p></p>
  </div>

  <div id="content">
    <p>Mutable value chains are sequences of immutable values which can be stored
in a Key-Value store (KVS) or Distributed hash table (DHT).</p>

<p>Mutable value chains solve the ``variable update problem’’ using
sequences of values to represent changes to a variable. Each new value
assigned to a variable is represented by adding a new value to the
sequence.</p>

<p>I’ll assume you know a little about DHTs and Key-Value stores and
show how a number of services can be deployed on top of Key-Value
stores or DHTs</p>

<p>I’ll also assume that the values stored in the KVS or DHT are
<em>immutable</em> - and look at the central problem of ``updating’’ an
immutable value.</p>

<p>This might sound complicated, but really it’s very easy and involves the idea
of an iterated sequence of SHA keys.</p>

<p>Iterated SHA keys offer a surprisingly simple way to store mutable
sequences of data in a Distributed Hash Table (DHT) like
<a href="https://en.wikipedia.org/wiki/Kademlia">Kademlia</a>
or massive Key-Value store (like <a href="http://basho.com/products/riak-kv/">Riak</a>).</p>

<h1 id="mutable-value-chains">Mutable Value Chains</h1>

<p>How can we modify immutable data?</p>

<p>The short answer is we can’t. Suppose we have some data base variable
<code class="highlighter-rouge">X</code> whose value changes with time. We might say that:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>X0 = 10
</code></pre>
</div>

<p>and some time later:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>X1 = 16
</code></pre>
</div>

<p>and so on. Instead of having a single variable <code class="highlighter-rouge">X</code> whose value changes
in time we can think of having a sequence of values <code class="highlighter-rouge">X0</code>, <code class="highlighter-rouge">X1</code>, <code class="highlighter-rouge">X2</code>,
… and so on where the values of <code class="highlighter-rouge">X0</code>, <code class="highlighter-rouge">X1</code> and so on are immutable (ie
never change).</p>

<p>The advantages of having immutable data are many. Firstly the values
are <strong>cacheable</strong> forever. Since we know the values cannot change we
can store them forever in an efficient manner. We can compress the
values and build indexes over them knowing that that data won’t
change. We also don’t have any problems with update consistency, since
they cannot be updated.</p>

<p>Cacheing works because of immutable data. GIT works because of
immutable data, Functional programming works because of immutable
data. Functional programs create new values from old values without
changing the old values which make it easy to argue about the
properties of the program. Things like debugging become easy because
old values are not overwritten.</p>

<p>So how can we make mutable sequences of values? If I say <code class="highlighter-rouge">x = 10</code>, how can I
later on say x = <code class="highlighter-rouge">20</code>, I can’t change the <em>value</em> of <code class="highlighter-rouge">10</code> so I can’t say ``and now
there’s a new value.’’</p>

<p>I’ve been wondering how to do this for years, and suddenly it occurred
to me how to do this. One way that doesn’t work is to view the
sequence of values as some kind of linked list, where each value has
an invisible write-once-only pointer to the next value. The
write-once-pointer gets updated when the value is updated,
unfortunately this is difficult to implement and there are problems
with consistency.</p>

<blockquote>
  <p>Keys are iterated SHA sequences</p>
</blockquote>

<p>The solution is blindingly simple (once you see it) - we represent the
sequence as a set Key-Value pairs where the Keys are taken from an
iterated sequence of SHA1 checksums. The first key is a random number,
thereafter <code class="highlighter-rouge">Key[i] = sha(Key[i-1])</code>.</p>

<h1 id="application-1---secure-mail">Application 1 - Secure Mail</h1>

<p><code class="highlighter-rouge">Ann</code> wants to send a stream of messages to <code class="highlighter-rouge">Bob</code>.</p>

<ul>
  <li><code class="highlighter-rouge">Ann</code> generates a 120 bit random number <code class="highlighter-rouge">K0</code></li>
  <li><code class="highlighter-rouge">Ann</code> communicates the value of <code class="highlighter-rouge">K0</code> to <code class="highlighter-rouge">Bob</code> by some out-of-band method (writing it down on a sheet of paper)</li>
  <li><code class="highlighter-rouge">Ann's</code> first mail to <code class="highlighter-rouge">Bob</code> is stored in a DHT with key <code class="highlighter-rouge">K0</code></li>
  <li><code class="highlighter-rouge">Ann's</code> second mail to <code class="highlighter-rouge">Bob</code> is stored in a DHT with key <code class="highlighter-rouge">sha(K0)</code></li>
  <li><code class="highlighter-rouge">Ann's</code> third mail to <code class="highlighter-rouge">Bob</code> is stored in a DHT with key <code class="highlighter-rouge">sha(sha(K0))</code></li>
  <li>…</li>
  <li><code class="highlighter-rouge">Bob</code> polls the DHT for <code class="highlighter-rouge">K0</code> to get the first mail</li>
  <li><code class="highlighter-rouge">Bob</code> polls the DHT for <code class="highlighter-rouge">sha(K0)</code> to get the second mail</li>
</ul>

<p>Assuming we use a DHT like Kademlia to store the data <code class="highlighter-rouge">Ann</code>
should republish the data (say) every hour and store the data on the
20 nearest nodes to the key.</p>

<h1 id="whats-in-the-value">What’s in the value?</h1>

<p>I haven’t said anything about the values that are stored at a particular key. There are
several alternatives. Assuming these values are tuples that have been serialized in
some way, we could choose:</p>

<p><code class="highlighter-rouge"><span class="p">{</span><span class="err">sha,Key1</span><span class="p">}</span></code> This is an indirection to a second document <code class="highlighter-rouge">Key1</code> is the SHA of a second
document stored in the DHT. The document is ``self-signed’’ ie has checksum <code class="highlighter-rouge">Key1</code>. The
client can fetch this document and check that it has SHA1 checksum of <code class="highlighter-rouge">Key1</code>. This
is immune to a thing-in-the-middle attack.</p>

<p><code class="highlighter-rouge"><span class="p">{</span><span class="err">s,Person,Key1,Data,Proof</span><span class="p">}</span></code> is a signed document. Person signed the document. <code class="highlighter-rouge">Key1</code> is
the SHA of a key in the DHT containing Person’s public key. <code class="highlighter-rouge">Data</code> is signed with
authentication <code class="highlighter-rouge">Proof</code></p>

<p><code class="highlighter-rouge"><span class="p">{</span><span class="err">e,...</span><span class="p">}</span></code> is an encrypted document …</p>

<p>As you can see there are many possibilities.</p>

<h1 id="application-2---decentralized-map">Application 2 - Decentralized map</h1>

<p>Given a sequence of values <code class="highlighter-rouge">X0</code>, <code class="highlighter-rouge">X1</code>, <code class="highlighter-rouge">X2</code>, <code class="highlighter-rouge">X3</code> compute a sequence of
values <code class="highlighter-rouge">Y0</code>, <code class="highlighter-rouge">Y1</code>, <code class="highlighter-rouge">Y2</code>, … where <code class="highlighter-rouge">Yi = f(Xi)</code>. This is easy:</p>

<ul>
  <li>Generate two random numbers <code class="highlighter-rouge">Kx0</code> and <code class="highlighter-rouge">Ky0</code></li>
  <li>Store <code class="highlighter-rouge">X0</code> in the DHT with key <code class="highlighter-rouge">Kx0</code></li>
  <li>Store <code class="highlighter-rouge">X1</code> in the DHT with key <code class="highlighter-rouge">sha(Kx0)</code></li>
  <li>…</li>
  <li>Compute <code class="highlighter-rouge">Y0 = f(X0)</code> and store the result in the DHT with key <code class="highlighter-rouge">Ky0</code></li>
  <li>Compute <code class="highlighter-rouge">Y1 = f(X1)</code> and store the result in the DHT with key <code class="highlighter-rouge">sha(Ky0)</code></li>
</ul>

<p>If the sequence of <code class="highlighter-rouge">X</code>’s is huge then multiple workers can be started tell them
to start computing values at different points in the value chain.</p>

<h1 id="application-3---software-upgrade">Application 3 - Software upgrade</h1>

<p>Suppose we have deployed some software on an extremely large number of machines.</p>

<p>Assume that we are at version 23 of some software. The ``Key’’ to this software
is <code class="highlighter-rouge">K23</code> (an SHA checksum) to fetch the software we lookup <code class="highlighter-rouge">K23</code> in our DHT,
and assume this is the SHA of the software. So:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  OurSoftware = lookup(lookup(K23))
</code></pre>
</div>

<p>Where <code class="highlighter-rouge">lookup(Key)</code> retrieves a value from a global DHT.</p>

<p>To publish new software the provider injects two new keys into the software.
Something like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code> SHA = sha(Blob),
 inject(SHA, Blob)
 inject(sha(K23), SHA)
</code></pre>
</div>

<p>Where <code class="highlighter-rouge">inject(Key, Value)</code> inserts a new value into the DHT (or KVS) and <code class="highlighter-rouge">Blob</code>
represents the software.</p>

<p>Clients at version <code class="highlighter-rouge">K23</code> poll the system by doing <code class="highlighter-rouge">lookup(sha(K23))</code> if a new value
is returned then the software needs to be upgraded.</p>

<p>Values can be protected and signed with a layer of cryptography</p>

<h1 id="application-4---digital-money">Application 4 - Digital Money</h1>

<p>It should be possible to make small closed groups of agents participating
in financial transactions. Once we have established secure message streams between
agents, we can add a server and a transaction layer in a manner similar to bitcoin.</p>

<p>By keeping the groups small the transaction chains will be short which simplifies the
implementation.</p>

<h1 id="will-the-keys-run-out">Will the keys run out?</h1>

<p>SHA which I have chosen in this article has 160 bits, so after more than <code class="highlighter-rouge">2^160</code>
entries have been put into the DHT collisions will occur.</p>

<p>To put this number in perspective we note that the number of atoms on
the planet is about 10^50 (2^166) and the volume of the universe/the
Planck volume is about 10^188 (c. 2^624) so we might need a larger key space
that that which is provided by SHA.</p>


  </div>

  <div id="tags">
    Tagged:
    
    <a href="/blog/tag/SHA">SHA</a> &nbsp;
    
    <a href="/blog/tag/values">values</a> &nbsp;
    
    <a href="/blog/tag/mutable">mutable</a> &nbsp;
    
    <a href="/blog/tag/data">data</a> &nbsp;
    
  </div>
  <p></p>

  <hr />
  
  <!-- the tweet button -->
  <p>
    <a href="https://twitter.com/share"  class="twitter-share-button" 
       data-url="http://joearms.github.com/2015/06/19/Mutable-Value_Chains.html">Tweet</a>
  </p>
  
  <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
  <!-- end of tweet button -->

  <p>Comments:</p>
  
  <div id="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      // var disqus_developer = 1;
      var disqus_shortname = 'joearmstrongsblog';
      var disqus_identifier = '/2015/06/19/Mutable-Value_Chains';
      var disqus_url = 'http://joearms.github.com/2015/06/19/Mutable-Value_Chains.html';
      (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
  </div>
  
  <noscript>
    Please enable JavaScript to view the <a
    href="http://disqus.com/?ref_noscript">comments powered by
    Disqus.</a>
  </noscript>
</div>

	</div>
	<div class="span3">
	  
	</div>
      </div>
    </div>
    
    <!-- Footer  ==================================== -->
    <footer class="footer">
      <div class="container">
	<p>&copy; 2013 Joe Armstrong</p>
	  Theme and code from <a href="https://github.com/mojombo">Tom
	  Preston-Werner</a>.<br /> Hosted by <a
	  href="https://github.com/networc/networc.github.com/">GitHub</a>
	  and powered by <a
	  href="https://github.com/mojombo/jekyll">Jekyll</a>.
	  Source code <a href="https://github.com/joearms/joearms.github.com">here</a>.
	</p>
	<p>
	  joearms@gmail.com <a href="http://github.com/joearms/">github.com/joearms</a>
	  <a href="http://twitter.com/joeerl/">twitter.com/joeerl</a>
	</p>
      </div>
    </footer>

    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-39670657-1', 'github.com');
      ga('send', 'pageview');
    </script>
    <!-- Google Analytics end -->
    
  </body>
</html>
