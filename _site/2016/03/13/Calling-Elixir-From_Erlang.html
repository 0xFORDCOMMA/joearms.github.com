<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Joe Armstrong" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    
    <title>Calling Elixir from Erlang</title>
    
    <!-- Bootstrap -->
    <link href="/css/bootstrap.min.css" rel="stylesheet" media="screen" />
    <link href="/css/bootstrap-responsive.min.css" rel="stylesheet" />
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />
    <link rel="stylesheet" href="/css/screen.css" type="text/css" 
	  media="screen, projection" />
  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
	<a class="brand" href="/index.html">Joe Armstrong - Erlang and other stuff</a>
	<ul class="nav">
	  <li><a href="/index.html">Home</a></li>
	  <li><a href="/archive.html">Archive</a></li>
	  <li><a href="/resources.html">Resources</a></li>
	  <li><a href="/installing.html">Installing</a></li>
	  <li><a href="/links.html">Links</a></li>
	  <li><a href="https://github.com/joearms/joearms.github.com/">Source</a></li>
	</ul>
      </div>
    </div>
    
    <div class="customize">
      <div class="row-fluid">
	<div class="span7 offset1">
	  <div>
  <div id="title">
  
    <h1>Calling Elixir from Erlang</h1>
    <span class="meta">13 Mar 2016</span>
    <p></p>
  </div>

  <div id="content">
    <p>I’ve been feeling inspired following Dave Thomas and Bruces Tate’s inspirational talk
<a href="https://www.youtube.com/watch?v=fklep3sUSWo]">We are Blessed</a>
that they gave at the <a href="http://www.erlang-factory.com/sfbay2016">Erlang factory</a>
so I started playing …</p>

<p>Part of the lecture described how Dave had thrown out a challenge to Bruce -
``Do something difficult in Elixir for a month’’ then talk to be about it.</p>

<p>Great I thought - I’ll cross compile Erlang into Elixir and see what happens -
I mentioned this to Dave and somebody in the coffee queue overheard the
conversation and said it was impossible - to which I though ``even
better, when can I start.’’ Attacking impossible problems is so much
more fun that attacking easy problems that you know you can solve.</p>

<p>And as Alan Kay said - ``If you don’t fail at least 90% of the time,
you’re not aiming high enough.’’</p>

<p>Cross compilation is just a matter of diddling with parse trees, so it should
in be principle ``be easy’’</p>

<blockquote>
  <p>If a computer scientist says that something is easy in principle, it
  means it might be really really difficult in practice, but they
  don’t know ‘cos they haven’t failed yet.</p>
</blockquote>

<p>So wanted to mess with the parse trees representing Erlang programs
and Elixir programs. I know what Erlang parse trees look like and what
they mean, but what about Elixir?</p>

<p>Specifically I wanted to parse an Elixir module, then turn the AST back to textual
representation and whap it into a file. Hopefully I’d get back what I started with.</p>

<p>We’ll see …</p>

<h1 id="getting-the-parse-tree">Getting the parse tree</h1>

<p>So now I wanted to call Elixir from Erlang so that I could explore the goodness of
Elixir from Erlang, but ran into a tiny problem.</p>

<p>Calling Erlang from Elixir is well documented but not the other way around.</p>

<p>After  a little tinkering I found that I could parse an Elixir file like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="err">:ok,</span><span class="w"> </span><span class="err">ast</span><span class="p">}</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">Code.string_to_quoted(File.read!(</span><span class="s2">"module.ex"</span><span class="err">))</span><span class="w">
</span></code></pre>
</div>

<p>and turn the ast into a string with</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Macro.to_string(ast)
</code></pre>
</div>

<blockquote>
  <p>With my Erlang hat on I thought the inverse of
<code class="highlighter-rouge">Code.string_to_quoted</code> would be <code class="highlighter-rouge">Code.quoted_to_string</code> <strong>but I was wrong</strong>
and the principle of least astonishment was violated again.</p>
</blockquote>

<h1 id="moving-on">Moving on…</h1>

<p>I now wanted to call <code class="highlighter-rouge">Code.string_to_quoted</code> and <code class="highlighter-rouge">File.read!</code> from
Erlang - so I ran into the - <em>where is this stuff</em> and <em>what is it
called</em> problem.</p>

<h1 id="where-is-my-elixir-stuff-and-how-can-erlang-find-it">Where is my Elixir stuff and how can Erlang find it?</h1>

<p>I messed around a bit and figured out that Erlang could find my Elixir code if I made
a <code class="highlighter-rouge">.erlang</code> file with the following:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>code:add_path("/usr/local/lib/elixir/lib/elixir/ebin/").
io:format("Elixir paths set~n").
</code></pre>
</div>

<p>And whoopydo happy days are here again, Erlang knows where the Elixir code is.</p>

<h1 id="what-are-the-functions-called">What are the functions called?</h1>

<p>But what are the functions called? Well <code class="highlighter-rouge">File.read!</code> in Elixir is just
<code class="highlighter-rouge">'Elixir.File':'read!'</code> in Erlang. That was easy. So now I wrote the Erlang code:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>test() -&gt;
   X = 'Elixir.File':'read!'("module.ex"),
   Ast = 'Elixir.Code':string_to_quoted(X).
</code></pre>
</div>

<p>Keeping my figures crossed I ran this in the Erlang shell:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&gt; test:test().
** exception error: bad argument
 in function  ets:lookup/2
    called as ets:lookup(elixir_config,compiler_options)
</code></pre>
</div>

<p>Ouch. Whaaaat the $#@!!$%$#@#<script type="math/tex"></script></p>

<p>Ooops I’ve gotta set some stuff up. <strong>How do I do this?</strong></p>

<p>So Now what? I could:</p>

<ul>
  <li>Google Google Google … (boring)</li>
  <li>Read the sources (deep sigh, do I really have to?)</li>
  <li>Write a blog article and hope some kind person adds a comment telling me how to do this</li>
</ul>

<p>In retrospect blogging and tweeting the blog is probably the fastest way to program.
I’ll time it and see.</p>

<p>Somebody out there knows how to do this, but I don’t know who.</p>

<blockquote>
  <p>This is the big problem with software - probably all software we want
has already been written - but we can’t find it so we do it ourselves.</p>
</blockquote>

<p>Now I’m off for lunch - hopefully when I get back somebody will have solved
it.</p>

<p>Have a nice one.</p>

<h1 id="added-notes">Added notes</h1>

<p>Yes - the experiment worked. By the time I’d got back from lunch, two
people had tweeted what to do. Both said ``start the Elixir application first.’’</p>

<p>So I tried this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&gt; application:start(elixir).
{error,{not_started,compiler}}
</code></pre>
</div>

<p>Not quite but getting warm: So yet another try:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1&gt; application:start(compiler).
ok
2&gt; application:start(elixir).  
ok
3&gt; test:test().                
{ok,{defmodule,[{line,2}],
           [{'__aliases__',[{counter,0},{line,2}],['ModuleName']},

   ...
</code></pre>
</div>

<p>The <code class="highlighter-rouge">...</code> above is because the shell output and the markdown
processor are not on speaking terms
and life is too short to wonder what:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Liquid Exception: Liquid syntax error: Variable ...
was not properly terminated with regexp:
</code></pre>
</div>

<p>and 3 more lines of gibberish means.</p>

<p>Not only does the mardown processor not do what I thought it should do
- but also the error message that it produces cannot be cut and paste into
this blog since this triggers the same error.</p>

<p>Which leave me wondering just exactly how difficult is it to bonk a bit of verbatim
text into a web page. Parse the stuff - wrap it in a HTML <code class="highlighter-rouge">pre</code> tag and quote the
less than and ampersand characters.</p>

<p>Life is full of surprises - and programming more so.</p>


  </div>

  <div id="tags">
    Tagged:
    
    <a href="/blog/tag/erlang">erlang</a> &nbsp;
    
    <a href="/blog/tag/elixir">elixir</a> &nbsp;
    
  </div>
  <p></p>

  <hr />
  
  <!-- the tweet button -->
  <p>
    <a href="https://twitter.com/share"  class="twitter-share-button" 
       data-url="http://joearms.github.com/2016/03/13/Calling-Elixir-From_Erlang.html">Tweet</a>
  </p>
  
  <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
  <!-- end of tweet button -->

  <p>Comments:</p>
  
  <div id="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      // var disqus_developer = 1;
      var disqus_shortname = 'joearmstrongsblog';
      var disqus_identifier = '/2016/03/13/Calling-Elixir-From_Erlang';
      var disqus_url = 'http://joearms.github.com/2016/03/13/Calling-Elixir-From_Erlang.html';
      (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
  </div>
  
  <noscript>
    Please enable JavaScript to view the <a
    href="http://disqus.com/?ref_noscript">comments powered by
    Disqus.</a>
  </noscript>
</div>

	</div>
	<div class="span3">
	  
	</div>
      </div>
    </div>
    
    <!-- Footer  ==================================== -->
    <footer class="footer">
      <div class="container">
	<p>&copy; 2013 Joe Armstrong</p>
	  Theme and code from <a href="https://github.com/mojombo">Tom
	  Preston-Werner</a>.<br /> Hosted by <a
	  href="https://github.com/networc/networc.github.com/">GitHub</a>
	  and powered by <a
	  href="https://github.com/mojombo/jekyll">Jekyll</a>.
	  Source code <a href="https://github.com/joearms/joearms.github.com">here</a>.
	</p>
	<p>
	  joearms@gmail.com <a href="http://github.com/joearms/">github.com/joearms</a>
	  <a href="http://twitter.com/joeerl/">twitter.com/joeerl</a>
	</p>
      </div>
    </footer>

    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-39670657-1', 'github.com');
      ga('send', 'pageview');
    </script>
    <!-- Google Analytics end -->
    
  </body>
</html>
